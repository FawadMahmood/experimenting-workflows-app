name: AI Agent Task Runner

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review_comment:
    types: [created]

jobs:
  template-job:
    runs-on: macos-latest
    if: github.event_name == 'pull_request' || github.event_name == 'pull_request_review_comment'
    environment: development
    env:
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      INPUT_ACTION: 'Run confirmed action'
    permissions:
      id-token: write
      contents: write
      actions: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || (github.event.pull_request && format('refs/pull/{0}/merge', github.event.pull_request.number)) }}

      - name: Display Input Parameters
        run: |
          echo "Action: $INPUT_ACTION"

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            
            const filePath = files.length > 0 ? files[0].filename : 'README.md';
            const position = files.length > 0 ? 1 : 1;
            
            const body = `ðŸ¤– Workflow run started for PR: [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\nTo run additional steps, reply to this review comment with any message.\n\nAvailable actions: run tests, deploy, lint, or run additional\n\n*Note: You can reply directly to this comment in the review thread.*`;
            
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              body: '',
              event: 'COMMENT',
              comments: [{
                path: filePath,
                position: position,
                body: body
              }]
            });

      - name: Comment on PR for reply
        if: github.event_name == 'pull_request_review_comment' && github.event.comment.user.login != 'github-actions'
        run: |
          # No comment posted to avoid spam

      - name: Run Action
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === 'pull_request') {
              console.log('Running initial action for PR event');
              // TODO: Add your initial custom steps here for PR events
            } else if (context.eventName === 'pull_request_review_comment' && context.payload.comment.user.login !== 'github-actions[bot]') {
              console.log(`Debug: Event=${context.eventName}, User=${context.payload.comment.user.login}, IInReplyTo=${context.payload.comment.in_reply_to_id}, Body='${context.payload.comment.body}'`);
              
              if (context.payload.comment.in_reply_to_id) {
                // Fetch parent comment
                const { data: parent } = await github.rest.pulls.getReviewComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: context.payload.comment.in_reply_to_id
                });
                
                console.log('Debug Parent:', parent);
                console.log('Debug PARENT_AUTHOR:', parent.user.login);
                
                if (parent.user.login === 'github-actions[bot]') {
                  console.log('Reply to bot\'s comment detected. Dispatching for reaction.');
                  
                  // Dispatch to comment reply processor
                  await github.rest.repos.createDispatchEvent({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    event_type: 'reply_and_react',
                    client_payload: {
                      reaction: '+1',
                      pr_number: context.payload.pull_request.number,
                      comment_id: context.payload.comment.id,
                      pr_head_ref: context.payload.pull_request.head.ref
                    }
                  });
                } else {
                  console.log('Not a reply to bot\'s comment');
                }
              } else {
                console.log('Not a reply, ignoring');
              }
            }